---
phase: 03-master-profile-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/src/profile/profile.module.ts
  - backend/src/profile/profile.controller.ts
  - backend/src/profile/profile.service.ts
  - backend/src/profile/dto/update-personal-info.dto.ts
  - backend/src/profile/dto/work-experience.dto.ts
  - backend/src/profile/dto/education.dto.ts
  - backend/src/profile/dto/project.dto.ts
  - backend/src/profile/dto/certification.dto.ts
  - backend/src/profile/dto/update-skills.dto.ts
  - backend/src/profile/dto/reorder.dto.ts
  - backend/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Prisma schema has order field on Skill model and credentialId on Certification"
    - "GET /profile returns the authenticated user's full profile with all sections"
    - "PATCH /profile/personal-info updates personal details"
    - "POST/PUT/DELETE endpoints exist for work experience, education, projects, certifications"
    - "PUT /profile/skills replaces the user's skill list"
    - "PATCH /profile/reorder updates ordering for any section"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "Updated Skill and Certification models"
      contains: "order.*Int"
    - path: "backend/src/profile/profile.controller.ts"
      provides: "All profile CRUD endpoints"
      exports: ["ProfileController"]
    - path: "backend/src/profile/profile.service.ts"
      provides: "Profile business logic with Prisma queries"
      exports: ["ProfileService"]
    - path: "backend/src/profile/profile.module.ts"
      provides: "NestJS module registration"
      exports: ["ProfileModule"]
  key_links:
    - from: "backend/src/profile/profile.controller.ts"
      to: "backend/src/profile/profile.service.ts"
      via: "dependency injection"
      pattern: "constructor.*ProfileService"
    - from: "backend/src/profile/profile.service.ts"
      to: "prisma.masterProfile"
      via: "Prisma Client queries"
      pattern: "prisma\\.masterProfile"
    - from: "backend/src/app.module.ts"
      to: "backend/src/profile/profile.module.ts"
      via: "module imports"
      pattern: "ProfileModule"
---

<objective>
Create the backend foundation for master profile management: update Prisma schema with missing fields, create the Profile NestJS module with full CRUD endpoints for all profile sections (personal info, work experience, education, projects, certifications, skills).

Purpose: All frontend profile forms need API endpoints to save/load data. This plan creates every endpoint the frontend will consume.
Output: Fully functional Profile REST API with validated DTOs, Prisma queries, and auth-guarded endpoints.
</objective>

<execution_context>
@C:\Users\pc\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pc\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-master-profile-management/03-CONTEXT.md
@.planning/phases/03-master-profile-management/03-RESEARCH.md
@backend/prisma/schema.prisma
@backend/src/app.module.ts
@backend/src/auth/guards/custom-throttler.guard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma schema and run migration</name>
  <files>backend/prisma/schema.prisma</files>
  <action>
Update the existing Prisma schema with the following changes:

1. **Skill model** - Add `order Int @default(0)` field for drag-drop reordering (currently missing)
2. **Certification model** - Add `credentialId String?` field per user decision. Change `issuer` to be required (`String` not `String?`) since issuer is a core field.
3. **Education model** - Add `order Int @default(0)` for reordering
4. **Project model** - Add `order Int @default(0)` for reordering
5. **Certification model** - Add `order Int @default(0)` for reordering

Do NOT change: Experience model (already has `order`, `bulletPoints String[]`, and all needed fields). MasterProfile model (already has `firstName`, `lastName`, `email`, `phone`, `location`, `noticePeriod`, `headline`, `summary`).

Note on bulletPoints: Keep the existing `String[]` array type on Experience. The user's "each bullet point is a separate text field" requirement maps to array elements, not a separate model. Client-side will generate temp IDs for dnd-kit.

After schema changes, generate the Prisma client:
```bash
cd backend && npx prisma generate
```

Create a migration (if Docker/DB available):
```bash
cd backend && npx prisma migrate dev --name add_profile_ordering_fields
```

If database is not available, just generate the client. The migration can run when Docker starts.
  </action>
  <verify>
Run `npx prisma validate` in backend directory to confirm schema is valid.
Run `npx prisma generate` to confirm client generation succeeds.
Verify Skill model has `order` field, Certification has `credentialId` field.
  </verify>
  <done>
Prisma schema updated with order fields on Skill, Education, Project, Certification models, and credentialId on Certification. Client generated successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Profile module with full CRUD API</name>
  <files>
    backend/src/profile/profile.module.ts
    backend/src/profile/profile.controller.ts
    backend/src/profile/profile.service.ts
    backend/src/profile/dto/update-personal-info.dto.ts
    backend/src/profile/dto/work-experience.dto.ts
    backend/src/profile/dto/education.dto.ts
    backend/src/profile/dto/project.dto.ts
    backend/src/profile/dto/certification.dto.ts
    backend/src/profile/dto/update-skills.dto.ts
    backend/src/profile/dto/reorder.dto.ts
    backend/src/app.module.ts
  </files>
  <action>
Create the Profile NestJS module following the existing pattern from AuthModule/UsersModule.

**DTOs (using class-validator + class-transformer):**

`update-personal-info.dto.ts`:
- firstName (string, required, min 1 max 100)
- lastName (string, required, min 1 max 100)
- email (string, required, IsEmail)
- phone (string, optional)
- location (string, optional)
- noticePeriod (string, optional)
- bio/summary (string, optional)

`work-experience.dto.ts` (CreateWorkExperienceDto and UpdateWorkExperienceDto):
- jobTitle (string, required, mapped to `position` in schema)
- company (string, required)
- location (string, optional)
- startDate (string/ISO date, required)
- endDate (string/ISO date, optional)
- current (boolean, default false)
- bulletPoints (string array, each min 1 char)
- order (number, optional)

`education.dto.ts`:
- institution (string, required)
- degree (string, required)
- fieldOfStudy (string, optional)
- startDate (string, required)
- endDate (string, optional)
- order (number, optional)

`project.dto.ts`:
- name (string, required)
- description (string, optional)
- technologies (string array)
- url (string, optional, IsUrl)
- order (number, optional)

`certification.dto.ts`:
- name (string, required)
- issuer (string, required)
- issueDate (string, optional)
- credentialId (string, optional)
- order (number, optional)

`update-skills.dto.ts`:
- skills: array of { name: string, order: number }

`reorder.dto.ts`:
- section: enum (experience, education, projects, certifications, skills)
- items: array of { id: string, order: number }

**ProfileService:**
- `getProfile(userId)` - Get or create profile. Use `findUnique` with includes for all relations ordered by `order` field. If no profile exists, create one with just userId and defaults from User table (firstName, lastName, email).
- `updatePersonalInfo(userId, dto)` - Upsert profile personal fields
- `addWorkExperience(userId, dto)` - Create new experience entry, auto-set order to max+1
- `updateWorkExperience(userId, experienceId, dto)` - Update existing experience (verify ownership via profileId)
- `deleteWorkExperience(userId, experienceId)` - Delete with ownership check
- `addEducation/updateEducation/deleteEducation` - Same pattern
- `addProject/updateProject/deleteProject` - Same pattern
- `addCertification/updateCertification/deleteCertification` - Same pattern
- `updateSkills(userId, dto)` - Replace all skills (delete existing, create new) in a transaction
- `reorderSection(userId, dto)` - Update order fields for given section items

**ProfileController:**
- All routes under `/profile` prefix
- All routes guarded with `@UseGuards(AuthenticatedGuard)` (reuse from auth module)
- Get user ID from session: `@Req() req` -> `req.user.id`

Endpoints:
- `GET /profile` -> getProfile
- `PATCH /profile/personal-info` -> updatePersonalInfo
- `POST /profile/experience` -> addWorkExperience
- `PUT /profile/experience/:id` -> updateWorkExperience
- `DELETE /profile/experience/:id` -> deleteWorkExperience
- `POST /profile/education` -> addEducation
- `PUT /profile/education/:id` -> updateEducation
- `DELETE /profile/education/:id` -> deleteEducation
- `POST /profile/projects` -> addProject
- `PUT /profile/projects/:id` -> updateProject
- `DELETE /profile/projects/:id` -> deleteProject
- `POST /profile/certifications` -> addCertification
- `PUT /profile/certifications/:id` -> updateCertification
- `DELETE /profile/certifications/:id` -> deleteCertification
- `PUT /profile/skills` -> updateSkills
- `PATCH /profile/reorder` -> reorderSection

**ProfileModule:**
- Import PrismaModule
- Declare ProfileController
- Provide ProfileService

**app.module.ts:**
- Add ProfileModule to imports array

Use the `@UseGuards(AuthenticatedGuard)` from `@backend/src/auth/guards/` for route protection. Check how the existing auth guards work before implementing.

Important: Map `jobTitle` in DTO to `position` in Prisma schema (the schema uses `position` but user decision says "job title").
  </action>
  <verify>
1. Run `cd backend && npm run build` to verify TypeScript compiles without errors
2. Check that all DTO files have proper class-validator decorators
3. Verify ProfileModule is imported in AppModule
4. Run `cd backend && npm test` (should pass or skip with no test files)
  </verify>
  <done>
Profile module created with full CRUD endpoints for all 6 profile sections. All endpoints are auth-guarded. DTOs validate nested data with class-validator. Module registered in AppModule. Backend compiles successfully.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx prisma validate` passes
2. `cd backend && npm run build` succeeds
3. Profile module is registered in app.module.ts imports
4. All CRUD endpoints defined in controller with proper guards
5. Service uses Prisma transactions where needed (skills replacement)
</verification>

<success_criteria>
- Prisma schema updated with ordering and credentialId fields
- Backend has /profile endpoint group with 17 CRUD operations
- All endpoints are auth-guarded
- DTOs validate all input with class-validator
- Backend compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-master-profile-management/03-01-SUMMARY.md`
</output>
