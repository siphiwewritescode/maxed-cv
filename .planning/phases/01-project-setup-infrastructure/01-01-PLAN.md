---
phase: 01-project-setup-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/tsconfig.build.json
  - backend/nest-cli.json
  - backend/nodemon.json
  - backend/src/main.ts
  - backend/src/app.module.ts
  - backend/src/config/env.validation.ts
  - backend/src/prisma/prisma.service.ts
  - backend/src/prisma/prisma.module.ts
  - backend/src/health/health.module.ts
  - backend/src/health/health.controller.ts
  - backend/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "NestJS backend compiles without TypeScript errors"
    - "Health check endpoint responds at GET /health"
    - "Prisma schema defines all v1 database models"
    - "Environment variables are validated at startup with Zod"
  artifacts:
    - path: "backend/src/main.ts"
      provides: "NestJS application entry point with validation pipe and env validation"
      contains: "NestFactory.create"
    - path: "backend/src/health/health.controller.ts"
      provides: "Health check endpoint using @nestjs/terminus"
      contains: "@HealthCheck"
    - path: "backend/prisma/schema.prisma"
      provides: "Complete database schema for all v1 phases"
      contains: "model User"
    - path: "backend/src/prisma/prisma.service.ts"
      provides: "Global Prisma database service"
      contains: "PrismaClient"
    - path: "backend/src/config/env.validation.ts"
      provides: "Zod-based environment variable validation"
      contains: "z.object"
  key_links:
    - from: "backend/src/app.module.ts"
      to: "backend/src/prisma/prisma.module.ts"
      via: "module import"
      pattern: "PrismaModule"
    - from: "backend/src/app.module.ts"
      to: "backend/src/health/health.module.ts"
      via: "module import"
      pattern: "HealthModule"
    - from: "backend/src/health/health.controller.ts"
      to: "backend/src/prisma/prisma.service.ts"
      via: "dependency injection for DB health check"
      pattern: "PrismaService"
---

<objective>
Scaffold the NestJS backend with Prisma ORM, health check endpoint, and environment validation.

Purpose: Establish the backend foundation that all future phases build upon -- database schema, API framework, and developer tooling.
Output: A compilable NestJS project in backend/ with Prisma schema covering all v1 models, a working health check endpoint, and Zod-based env validation.
</objective>

<execution_context>
@C:\Users\pc\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pc\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup-infrastructure/01-CONTEXT.md
@.planning/phases/01-project-setup-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold NestJS project with Prisma schema</name>
  <files>
    backend/package.json
    backend/tsconfig.json
    backend/tsconfig.build.json
    backend/nest-cli.json
    backend/prisma/schema.prisma
  </files>
  <action>
    Create the backend/ directory and initialize a NestJS project. Do NOT use `nest new` CLI (it creates its own git repo). Instead, manually create the project structure.

    1. Create backend/package.json with these dependencies:
       - @nestjs/common, @nestjs/core, @nestjs/platform-express (^11.0.0)
       - @prisma/client (^7.1.0)
       - @nestjs/terminus (^10.0.0)
       - class-validator (^0.14.0), class-transformer (^0.5.0)
       - zod (^3.22.0), dotenv (^16.0.0)
       - reflect-metadata, rxjs
       - Dev: @nestjs/cli, @nestjs/schematics, @nestjs/testing (^11.0.0)
       - Dev: prisma (^7.1.0), typescript (^5.0.0), ts-node (^10.0.0), nodemon (^3.0.0)
       - Dev: @types/node, @types/express, ts-jest, jest
       - Scripts: start:dev (nodemon), build (nest build), start:prod, prisma:generate, prisma:migrate, prisma:seed, prisma:reset, prisma:studio, test
       - Add postinstall script: "prisma generate"
       - Add prisma.seed config: "ts-node prisma/seed.ts"

    2. Create backend/tsconfig.json with strict TypeScript settings:
       - target: ES2021, module: commonjs, strict: true
       - emitDecoratorMetadata: true, experimentalDecorators: true
       - outDir: ./dist, rootDir: ./src
       - skipLibCheck: true, forceConsistentCasingInFileNames: true

    3. Create backend/tsconfig.build.json extending tsconfig.json, excluding node_modules, test, dist, **/*spec.ts

    4. Create backend/nest-cli.json with sourceRoot: "src", compilerOptions for plugins

    5. Create backend/nodemon.json:
       - watch: ["src"]
       - ext: "ts"
       - exec: "ts-node -r tsconfig-paths/register src/main.ts"
       - legacyWatch: true (critical for Docker file watching)

    6. Create backend/prisma/schema.prisma with ALL v1 models:
       - datasource: postgresql
       - generator: client (provider: prisma-client-js)
       - model User: id (UUID, default cuid), email (unique), name, passwordHash (optional, Phase 2), emailVerified (DateTime, optional), createdAt, updatedAt
       - model MasterProfile: id, userId (relation to User, unique), firstName, lastName, email, phone (optional), location (optional), headline (optional), summary (optional), noticePeriod (optional, String for SA-specific), createdAt, updatedAt
       - model Experience: id, profileId (relation), company, position, location (optional), startDate, endDate (optional), description (optional), bulletPoints (String[]), order (Int, default 0), createdAt, updatedAt
       - model Skill: id, profileId (relation), name, category (optional), createdAt
       - model Project: id, profileId (relation), name, description (optional), url (optional), technologies (String[]), createdAt, updatedAt
       - model Education: id, profileId (relation), institution, degree, fieldOfStudy (optional), startDate, endDate (optional), location (optional), createdAt, updatedAt
       - model Certification: id, profileId (relation), name, issuer (optional), issueDate (optional), expiryDate (optional), url (optional), createdAt
       - model Job: id, userId (relation), url (optional), title, company (optional), location (optional), description (String), requirements (String[]), rawHtml (optional), source (String -- linkedin, pnet, etc.), scrapedAt, createdAt
       - model GeneratedCV: id, userId (relation), jobId (relation), profileId (relation), content (Json), atsScore (Float, optional), status (enum: PENDING, PROCESSING, COMPLETED, FAILED), filename (optional), createdAt, updatedAt
       - enum CVStatus: PENDING, PROCESSING, COMPLETED, FAILED

       All models use cuid() for IDs. All have appropriate @@index for foreign keys.
       Add cascade delete where appropriate (User -> MasterProfile -> Experience/Skill/Project/Education/Certification).

    Run `cd backend && npm install` to install dependencies. Then run `npx prisma generate` to generate the Prisma client.
  </action>
  <verify>
    Run from backend directory:
    - `npm ls @nestjs/core` shows installed
    - `npm ls @prisma/client` shows installed
    - `npx prisma validate` exits with 0 (schema is valid)
    - `npx tsc --noEmit` compiles without errors (after Task 2 creates source files)
  </verify>
  <done>
    backend/package.json exists with all required dependencies. backend/prisma/schema.prisma defines User, MasterProfile, Experience, Skill, Project, Education, Certification, Job, GeneratedCV models with proper relations. Prisma client generates successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NestJS application modules (Prisma, Health, Config)</name>
  <files>
    backend/src/main.ts
    backend/src/app.module.ts
    backend/src/config/env.validation.ts
    backend/src/prisma/prisma.service.ts
    backend/src/prisma/prisma.module.ts
    backend/src/health/health.module.ts
    backend/src/health/health.controller.ts
  </files>
  <action>
    Create the NestJS application source code with modular architecture.

    1. Create backend/src/config/env.validation.ts:
       - Define Zod schema validating: NODE_ENV (enum dev/prod/test, default dev), PORT (numeric string transformed to number, default 3001), DATABASE_URL (string, required), REDIS_HOST (string, default localhost), REDIS_PORT (numeric string, default 6379)
       - Export validateEnv() function that calls safeParse on process.env, throws descriptive error on failure, returns typed Env object on success
       - Export Env type

    2. Create backend/src/prisma/prisma.service.ts:
       - Injectable service extending PrismaClient
       - Implements OnModuleInit (call $connect), OnModuleDestroy (call $disconnect)
       - Log connection status on connect/disconnect

    3. Create backend/src/prisma/prisma.module.ts:
       - @Global() module exporting PrismaService
       - Makes PrismaService available across all modules without re-importing

    4. Create backend/src/health/health.controller.ts:
       - GET /health endpoint using @nestjs/terminus HealthCheckService
       - Check database connectivity via Prisma (use custom check: try prisma.$queryRaw`SELECT 1`, return healthy/unhealthy)
       - Note: @nestjs/terminus PrismaHealthIndicator may not exist in all versions. Use a custom health indicator that injects PrismaService and runs a raw query. If PrismaHealthIndicator is available in terminus v10+, use it. Otherwise create a custom one.

    5. Create backend/src/health/health.module.ts:
       - Import TerminusModule
       - Register HealthController
       - Import any custom health indicators

    6. Create backend/src/app.module.ts:
       - Import PrismaModule and HealthModule
       - Root module for the application

    7. Create backend/src/main.ts:
       - Import dotenv/config at very top (before other imports)
       - Call validateEnv() to fail fast on invalid config
       - Create NestJS app with AppModule
       - Enable CORS (origin: process.env.FRONTEND_URL or http://localhost:3000 for dev)
       - Set global ValidationPipe with whitelist: true, forbidNonWhitelisted: true, transform: true
       - Listen on env.PORT (default 3001)
       - Log startup URL
  </action>
  <verify>
    From backend directory, with DATABASE_URL set to any valid-looking postgres URL:
    - `npx tsc --noEmit` compiles without TypeScript errors
    - Verify all 7 source files exist and are non-empty
    - Check that app.module.ts imports both PrismaModule and HealthModule
    - Check that main.ts calls validateEnv() before NestFactory.create
  </verify>
  <done>
    NestJS application compiles. main.ts validates env vars at startup. PrismaModule is globally available. HealthController at GET /health checks database connectivity. All modules properly wired in AppModule.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsc --noEmit` -- Zero TypeScript errors
2. `cd backend && npx prisma validate` -- Schema is valid
3. All source files exist: main.ts, app.module.ts, env.validation.ts, prisma.service.ts, prisma.module.ts, health.module.ts, health.controller.ts
4. prisma/schema.prisma defines 9 models (User, MasterProfile, Experience, Skill, Project, Education, Certification, Job, GeneratedCV)
5. package.json has all required scripts (start:dev, prisma:generate, prisma:migrate, prisma:seed, prisma:reset)
</verification>

<success_criteria>
- Backend TypeScript compiles without errors
- Prisma schema validates successfully with all v1 models defined
- Health check controller exists and is wired into app module
- Environment validation fails fast on missing DATABASE_URL
- Project structure matches: backend/src/{config,prisma,health}/ modular layout
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-infrastructure/01-01-SUMMARY.md`
</output>
