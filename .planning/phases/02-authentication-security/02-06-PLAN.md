---
phase: 02-authentication-security
plan: 06
type: execute
wave: 4
depends_on: ["02-04", "02-05"]
files_modified:
  - backend/src/auth/auth.controller.ts
  - backend/src/auth/guards/custom-throttler.guard.ts
  - backend/src/auth/middleware/absolute-session-expiry.middleware.ts
  - backend/src/app.module.ts
  - backend/prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "Login endpoint rate-limited to 5 attempts per minute"
    - "Signup endpoint rate-limited to 3 per minute"
    - "Resend verification rate-limited to 1 per 5 minutes"
    - "Password reset request rate-limited to 1 per 5 minutes"
    - "Session has absolute maximum expiry (7 days default, 30 days with remember me)"
    - "Seed data updated to work with new auth schema"
  artifacts:
    - path: "backend/src/auth/guards/custom-throttler.guard.ts"
      provides: "Rate limiter using user ID when authenticated, IP when anonymous"
      exports: ["CustomThrottlerGuard"]
    - path: "backend/src/auth/middleware/absolute-session-expiry.middleware.ts"
      provides: "Middleware to enforce absolute session lifetime"
      exports: ["AbsoluteSessionExpiryMiddleware"]
  key_links:
    - from: "backend/src/auth/auth.controller.ts"
      to: "@nestjs/throttler"
      via: "@Throttle decorator on auth endpoints"
      pattern: "@Throttle"
    - from: "backend/src/app.module.ts"
      to: "@nestjs/throttler"
      via: "ThrottlerModule.forRoot"
      pattern: "ThrottlerModule"
---

<objective>
Add rate limiting to auth endpoints, implement absolute session expiry middleware, integrate session tracking into login/logout, and update seed data for the new schema.

Purpose: Complete security hardening -- rate limiting prevents brute force attacks, absolute session expiry ensures sessions don't live forever even with sliding expiration, and session tracking enables multi-device limits.
Output: Fully hardened authentication system with rate limiting, session management, and working seed data.
</objective>

<execution_context>
@C:\Users\pc\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pc\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-security/02-RESEARCH.md
@.planning/phases/02-authentication-security/02-04-SUMMARY.md
@.planning/phases/02-authentication-security/02-05-SUMMARY.md
@backend/src/auth/auth.controller.ts
@backend/src/auth/auth.service.ts
@backend/src/sessions/sessions.service.ts
@backend/src/app.module.ts
@backend/prisma/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate limiting and session expiry middleware</name>
  <files>
    backend/src/auth/guards/custom-throttler.guard.ts
    backend/src/auth/middleware/absolute-session-expiry.middleware.ts
    backend/src/auth/auth.controller.ts
    backend/src/app.module.ts
  </files>
  <action>
**Create `backend/src/auth/guards/custom-throttler.guard.ts`:**

Extend ThrottlerGuard to use user ID for authenticated requests (prevents IP-based blocking of users behind shared NAT/VPN) and fall back to IP for anonymous requests:

```typescript
@Injectable()
export class CustomThrottlerGuard extends ThrottlerGuard {
  protected async getTracker(req: Record<string, any>): Promise<string> {
    if (req.session?.passport?.user) {
      return `user:${req.session.passport.user}`;
    }
    return req.ip;
  }
}
```

**Update `backend/src/app.module.ts`:**

Add ThrottlerModule to imports:

```typescript
ThrottlerModule.forRoot([
  {
    name: 'default',
    ttl: 60000,  // 60 seconds
    limit: 20,   // 20 requests per minute (general)
  },
  {
    name: 'auth',
    ttl: 60000,  // 60 seconds
    limit: 5,    // 5 requests per minute for auth routes
  },
]),
```

Register CustomThrottlerGuard as APP_GUARD:
```typescript
providers: [
  {
    provide: APP_GUARD,
    useClass: CustomThrottlerGuard,
  },
],
```

Import APP_GUARD from '@nestjs/core', ThrottlerModule from '@nestjs/throttler'.
Import CustomThrottlerGuard from the auth guards.

NOTE: The health endpoint should skip throttling. Add @SkipThrottle() decorator to the HealthController (edit backend/src/health/health.controller.ts to add this import and decorator).

**Update `backend/src/auth/auth.controller.ts`:**

Add @Throttle decorators to auth endpoints per user decisions:

```typescript
@Post('signup')
@Throttle({ auth: { limit: 3, ttl: 60000 } })  // 3 signups per minute
async signup(...) { ... }

@Post('login')
@Throttle({ auth: { limit: 5, ttl: 60000 } })  // 5 login attempts per minute
async login(...) { ... }

@Post('resend-verification')
@Throttle({ auth: { limit: 1, ttl: 300000 } })  // 1 per 5 minutes per user decision
async resendVerification(...) { ... }

@Post('forgot-password')
@Throttle({ auth: { limit: 1, ttl: 300000 } })  // 1 per 5 minutes per user decision
async forgotPassword(...) { ... }

@SkipThrottle()  // No rate limit on logout
@Post('logout')
async logout(...) { ... }
```

**Create `backend/src/auth/middleware/absolute-session-expiry.middleware.ts`:**

NestMiddleware that checks absolute session lifetime:

```typescript
@Injectable()
export class AbsoluteSessionExpiryMiddleware implements NestMiddleware {
  use(req: any, res: any, next: Function) {
    if (req.session?.passport?.user && req.session?.createdAt) {
      const maxAge = req.session.rememberMe
        ? 30 * 24 * 60 * 60 * 1000  // 30 days absolute max with "remember me"
        : 7 * 24 * 60 * 60 * 1000;  // 7 days absolute max default

      if (Date.now() - req.session.createdAt > maxAge) {
        req.session.destroy((err: any) => {
          if (err) console.error('Session destroy error:', err);
        });
        // Don't throw -- just clear session and continue (let AuthenticatedGuard handle 401)
        return next();
      }
    }
    next();
  }
}
```

Apply middleware in AppModule by implementing NestModule:
```typescript
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(AbsoluteSessionExpiryMiddleware).forRoutes('*');
  }
}
```
  </action>
  <verify>
Run `cd backend && npx tsc --noEmit` -- all files compile.
Check that auth.controller.ts has @Throttle decorators on signup, login, resend-verification, forgot-password.
Check that app.module.ts has ThrottlerModule imported with auth configuration.
Check that AbsoluteSessionExpiryMiddleware is applied via AppModule.configure().
  </verify>
  <done>
Rate limiting applied: signup (3/min), login (5/min), resend-verification (1/5min per user decision), forgot-password (1/5min per user decision), logout (no limit). CustomThrottlerGuard uses user ID for authenticated requests, IP for anonymous. AbsoluteSessionExpiryMiddleware enforces 7-day (default) or 30-day (remember me) absolute maximum session lifetime alongside sliding expiration. Health endpoint skips throttling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate session tracking into auth flow and update seed data</name>
  <files>
    backend/src/auth/auth.controller.ts
    backend/src/auth/auth.service.ts
    backend/prisma/seed.ts
  </files>
  <action>
**Integrate SessionsService into auth.controller.ts login and logout:**

In the login endpoint (POST /auth/login), after session is saved:
- Extract session ID: `const sessionId = req.sessionID;`
- Track session: `await this.sessionsService.addUserSession(user.id, sessionId);`
- This enforces the 3-device limit per user decision

In the logout endpoint (POST /auth/logout):
- Before destroying session: `await this.sessionsService.removeUserSession(req.session.passport.user, req.sessionID);`
- Then destroy session as before

Similarly, in OAuth callback endpoints (google/callback, linkedin/callback):
- After session.save: `await this.sessionsService.addUserSession(user.id, req.sessionID);`

In the signup endpoint (POST /auth/signup):
- After auto-login session: track the session same as login

Make sure the auth.controller.ts constructor injects SessionsService.

**Update `backend/prisma/seed.ts`:**

The existing seed data creates a User with fields that may not match the updated schema. Update the seed script to:

1. Add the new User fields: `firstName`, `lastName`, `googleId: null`, `linkedinId: null`, `avatar: null`
   - Keep existing `name` field for backward compatibility
   - Set `firstName: 'Sipho'` and `lastName: 'Ngwenya'`

2. Add password hash for the test user so login works:
   - Import bcrypt: `import * as bcrypt from 'bcrypt';`
   - Hash a known password: `const passwordHash = await bcrypt.hash('Test@1234', 13);`
   - Add `passwordHash` to user creation
   - Document the test password in seed output: "Password: Test@1234"

3. Also delete VerificationToken and PasswordResetToken in the clear step (add these before User deletion since they have foreign keys):
   ```typescript
   await prisma.verificationToken.deleteMany();
   await prisma.passwordResetToken.deleteMany();
   ```

4. Keep all existing seed data (experiences, skills, projects, education, certifications, jobs) exactly as they are.
  </action>
  <verify>
Run `cd backend && npx tsc --noEmit` -- seed.ts compiles.
Run `cd backend && npx prisma validate` -- schema valid.
If Docker available:
- Run seed: `npm run prisma:seed` -- should succeed
- Login with test@maxedcv.com / Test@1234 -- should return 200
- Verify session tracking: check Redis for user session set
  </verify>
  <done>
Session tracking integrated into all auth flows (login, signup, OAuth callbacks, logout). Max 3 concurrent sessions enforced via SessionsService.addUserSession() call after every successful authentication. Seed data updated with firstName, lastName, passwordHash (Test@1234), and new token model cleanup in the clear step.
  </done>
</task>

</tasks>

<verification>
- Rate limiting active on all auth endpoints with correct limits
- CustomThrottlerGuard uses user ID for authenticated, IP for anonymous
- AbsoluteSessionExpiryMiddleware destroys sessions past absolute max age
- Session tracked in Redis after login, signup, and OAuth callback
- Session removed from Redis on logout
- 4th login from new device evicts oldest session
- Seed data works with updated schema (includes passwordHash, firstName, lastName)
- Test account can log in with Test@1234 password
- Backend compiles with `npx tsc --noEmit`
</verification>

<success_criteria>
Authentication system is fully hardened: rate limiting prevents brute force (5 login/min, 3 signup/min, 1 reset/5min, 1 resend/5min), sessions tracked per user with 3-device max, absolute session expiry enforced (7/30 days), and seed data works with the new auth schema.
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-security/02-06-SUMMARY.md`
</output>
