---
phase: 02-authentication-security
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/sessions/sessions.module.ts
  - backend/src/sessions/sessions.service.ts
  - backend/src/email/email.module.ts
  - backend/src/email/email.service.ts
  - backend/src/email/templates/verification.hbs
  - backend/src/email/templates/password-reset.hbs
  - backend/src/email/templates/password-changed.hbs
  - backend/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "SessionsService can track, list, and remove sessions per user via Redis"
    - "Max 3 concurrent sessions enforced (oldest evicted when 4th created)"
    - "All user sessions can be invalidated at once (for password reset)"
    - "EmailService can send verification, password reset, and password changed emails"
    - "Email templates render with Handlebars variables"
  artifacts:
    - path: "backend/src/sessions/sessions.service.ts"
      provides: "Multi-device session management with Redis"
      exports: ["SessionsService"]
    - path: "backend/src/email/email.service.ts"
      provides: "Email sending via Nodemailer with Handlebars templates"
      exports: ["EmailService"]
    - path: "backend/src/email/templates/verification.hbs"
      provides: "Email verification email template"
      contains: "verificationUrl"
    - path: "backend/src/email/templates/password-reset.hbs"
      provides: "Password reset email template"
      contains: "resetUrl"
    - path: "backend/src/email/templates/password-changed.hbs"
      provides: "Password changed notification template"
      contains: "changeTime"
  key_links:
    - from: "backend/src/sessions/sessions.service.ts"
      to: "redis"
      via: "ioredis for session tracking"
      pattern: "redis\\.sadd|redis\\.smembers|redis\\.del"
    - from: "backend/src/email/email.module.ts"
      to: "@nestjs-modules/mailer"
      via: "MailerModule.forRootAsync"
      pattern: "MailerModule"
---

<objective>
Create the Sessions management service (multi-device tracking, session limits, bulk invalidation) and Email module (verification, password reset, password changed templates).

Purpose: These are shared services consumed by auth flows in Plans 04 and 05. Sessions enable the 3-device limit and "logout all devices" features. Email enables verification and password reset flows.
Output: SessionsService and EmailService ready for injection into AuthService.
</objective>

<execution_context>
@C:\Users\pc\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pc\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-security/02-RESEARCH.md
@.planning/phases/02-authentication-security/02-01-SUMMARY.md
@backend/src/config/env.validation.ts
@backend/src/app.module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sessions management service with Redis</name>
  <files>
    backend/src/sessions/sessions.module.ts
    backend/src/sessions/sessions.service.ts
  </files>
  <action>
**Create `backend/src/sessions/sessions.service.ts`:**

Injectable service. Create a Redis client internally using ioredis (import Redis from 'ioredis') with host/port from ConfigService (@nestjs/config).

Methods:

1. `addUserSession(userId: string, sessionId: string): Promise<void>`:
   - Add sessionId to Redis set `user:{userId}:sessions` using `redis.sadd()`
   - Check set size with `redis.scard()`
   - If size > 3: get all members with `redis.smembers()`, sort by insertion order (or just pick first returned), remove oldest:
     - `redis.srem()` from user's set
     - `redis.del('sess:' + oldestSessionId)` to destroy the actual session
   - Per user decision: Max 3 concurrent sessions, oldest logged out when 4th device logs in

2. `removeUserSession(userId: string, sessionId: string): Promise<void>`:
   - `redis.srem('user:{userId}:sessions', sessionId)`

3. `getUserSessions(userId: string): Promise<string[]>`:
   - `redis.smembers('user:{userId}:sessions')`

4. `removeAllUserSessions(userId: string): Promise<void>`:
   - Get all session IDs via `smembers`
   - For each sessionId: `redis.del('sess:' + sessionId)` to destroy session data
   - `redis.del('user:{userId}:sessions')` to clear the tracking set
   - Per user decision: Used when password is reset to log out all devices

5. `getSessionCount(userId: string): Promise<number>`:
   - `redis.scard('user:{userId}:sessions')`

Constructor should create Redis instance:
```typescript
constructor(private configService: ConfigService) {
  this.redis = new Redis({
    host: this.configService.get('REDIS_HOST', 'localhost'),
    port: this.configService.get('REDIS_PORT', 6379),
  });
}
```

Implement OnModuleDestroy to close Redis connection: `this.redis.disconnect()`.

**Create `backend/src/sessions/sessions.module.ts`:**

Provide and export SessionsService.
```typescript
@Module({
  providers: [SessionsService],
  exports: [SessionsService],
})
export class SessionsModule {}
```
  </action>
  <verify>
Run `cd backend && npx tsc --noEmit` -- SessionsModule compiles.
  </verify>
  <done>
SessionsService manages per-user session tracking in Redis using sets. Enforces max 3 concurrent sessions by evicting oldest when limit exceeded. Supports bulk session invalidation for password reset flow. All operations are atomic Redis commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Email module with Handlebars templates</name>
  <files>
    backend/src/email/email.module.ts
    backend/src/email/email.service.ts
    backend/src/email/templates/verification.hbs
    backend/src/email/templates/password-reset.hbs
    backend/src/email/templates/password-changed.hbs
    backend/src/app.module.ts
  </files>
  <action>
**Create `backend/src/email/email.module.ts`:**

Use MailerModule.forRootAsync with ConfigService injection:

```typescript
@Module({
  imports: [
    MailerModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        transport: {
          host: config.get('EMAIL_HOST', 'smtp.gmail.com'),
          port: config.get('EMAIL_PORT', 587),
          secure: false,
          auth: {
            user: config.get('EMAIL_USER'),
            pass: config.get('EMAIL_PASSWORD'),
          },
        },
        defaults: {
          from: config.get('EMAIL_FROM', '"Maxed-CV" <noreply@maxedcv.com>'),
        },
        template: {
          dir: join(__dirname, 'templates'),
          adapter: new HandlebarsAdapter(),
          options: { strict: true },
        },
      }),
    }),
  ],
  providers: [EmailService],
  exports: [EmailService],
})
export class EmailModule {}
```

Import HandlebarsAdapter from `@nestjs-modules/mailer/dist/adapters/handlebars.adapter`.
Import { join } from 'path'.

**Create `backend/src/email/email.service.ts`:**

Injectable service. Inject MailerService from @nestjs-modules/mailer.

Methods:

1. `sendVerificationEmail(email: string, verificationUrl: string): Promise<void>`:
   - Try/catch the mailer call. Log error but don't throw (app shouldn't crash if email fails during dev without SMTP configured)
   - Template: `./verification`
   - Subject: `Verify your Maxed-CV account`
   - Context: `{ verificationUrl, expiryHours: 24 }`

2. `sendPasswordResetEmail(email: string, resetUrl: string): Promise<void>`:
   - Template: `./password-reset`
   - Subject: `Reset your Maxed-CV password`
   - Context: `{ resetUrl, expiryMinutes: 60 }`

3. `sendPasswordChangedEmail(email: string): Promise<void>`:
   - Template: `./password-changed`
   - Subject: `Your Maxed-CV password was changed`
   - Context: `{ changeTime: new Date().toLocaleString('en-ZA') }` (SA locale)

All methods should wrap in try/catch and log warning on failure (not throw), so the app works in development without email configuration. Use NestJS Logger.

**Create email templates** (Handlebars .hbs files):

`backend/src/email/templates/verification.hbs`:
```html
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
  <h1 style="color: #1a1a2e;">Verify your email address</h1>
  <p>Welcome to Maxed-CV! Please verify your email address by clicking the button below.</p>
  <p style="text-align: center; margin: 30px 0;">
    <a href="{{verificationUrl}}" style="background-color: #1a1a2e; color: #ffffff; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block;">Verify Email</a>
  </p>
  <p style="color: #666;">This link expires in {{expiryHours}} hours.</p>
  <p style="color: #666;">If you didn't create an account on Maxed-CV, you can safely ignore this email.</p>
  <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
  <p style="color: #999; font-size: 12px;">Maxed-CV - AI-Powered CV Tailoring for South African Professionals</p>
</body>
</html>
```

`backend/src/email/templates/password-reset.hbs`:
```html
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
  <h1 style="color: #1a1a2e;">Reset your password</h1>
  <p>We received a request to reset your Maxed-CV password. Click the button below to choose a new password.</p>
  <p style="text-align: center; margin: 30px 0;">
    <a href="{{resetUrl}}" style="background-color: #1a1a2e; color: #ffffff; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block;">Reset Password</a>
  </p>
  <p style="color: #666;">This link expires in {{expiryMinutes}} minutes.</p>
  <p style="color: #666;">If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.</p>
  <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
  <p style="color: #999; font-size: 12px;">Maxed-CV - AI-Powered CV Tailoring for South African Professionals</p>
</body>
</html>
```

`backend/src/email/templates/password-changed.hbs`:
```html
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
  <h1 style="color: #1a1a2e;">Password changed</h1>
  <p>Your Maxed-CV password was successfully changed on {{changeTime}}.</p>
  <p>All other sessions have been logged out for your security.</p>
  <p style="color: #666;">If you didn't make this change, please contact us immediately or reset your password.</p>
  <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
  <p style="color: #999; font-size: 12px;">Maxed-CV - AI-Powered CV Tailoring for South African Professionals</p>
</body>
</html>
```

**Update `backend/src/app.module.ts`:**

Add imports for SessionsModule and EmailModule (alongside UsersModule and AuthModule from Plan 02).

NOTE: Since Plan 02 also modifies app.module.ts, and Plan 02 and 03 are both Wave 2, there is a file conflict. To handle this: Plan 03 should ADD its imports (SessionsModule, EmailModule) to whatever is already in app.module.ts at execution time. Read the file first, then add the new imports.
  </action>
  <verify>
Run `cd backend && npx tsc --noEmit` -- EmailModule and SessionsModule compile.
Check that all 3 .hbs template files exist in backend/src/email/templates/.
Check that app.module.ts imports SessionsModule and EmailModule.
  </verify>
  <done>
SessionsModule provides SessionsService for multi-device session tracking via Redis sets (max 3 concurrent, bulk invalidation). EmailModule provides EmailService with 3 Handlebars email templates (verification, password-reset, password-changed) using @nestjs-modules/mailer. Email methods gracefully handle SMTP failures (log warning, don't crash) for development without email configuration.
  </done>
</task>

</tasks>

<verification>
- SessionsService methods: addUserSession, removeUserSession, getUserSessions, removeAllUserSessions, getSessionCount
- EmailService methods: sendVerificationEmail, sendPasswordResetEmail, sendPasswordChangedEmail
- All 3 Handlebars templates exist and contain correct variables
- app.module.ts imports SessionsModule and EmailModule
- Backend compiles with `npx tsc --noEmit`
</verification>

<success_criteria>
SessionsService can track sessions per user in Redis, enforce 3-device limit (oldest evicted), and invalidate all sessions at once. EmailService can send verification, password reset, and password changed emails using Handlebars templates. Both services handle failures gracefully in development.
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-security/02-03-SUMMARY.md`
</output>
