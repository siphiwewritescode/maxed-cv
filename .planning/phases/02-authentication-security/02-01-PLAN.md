---
phase: 02-authentication-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/package.json
  - backend/src/config/env.validation.ts
  - backend/src/main.ts
  - backend/.env.example
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "Auth dependencies are installed and importable"
    - "Prisma schema has OAuth fields, VerificationToken, and PasswordResetToken models"
    - "Session middleware is configured with Redis store in main.ts"
    - "Passport is initialized and attached to the Express app"
    - "Environment validation requires SESSION_SECRET (min 32 chars)"
  artifacts:
    - path: "backend/prisma/schema.prisma"
      provides: "Updated User model with OAuth fields + VerificationToken + PasswordResetToken models"
      contains: "model VerificationToken"
    - path: "backend/src/main.ts"
      provides: "Session + Passport middleware bootstrapped"
      contains: "passport.initialize"
    - path: "backend/src/config/env.validation.ts"
      provides: "Auth-related env vars validated"
      contains: "SESSION_SECRET"
  key_links:
    - from: "backend/src/main.ts"
      to: "redis"
      via: "ioredis client for session store"
      pattern: "RedisStore|connect-redis"
    - from: "backend/src/main.ts"
      to: "express-session"
      via: "session middleware"
      pattern: "app\\.use.*session"
---

<objective>
Install all authentication dependencies, update Prisma schema with OAuth and token models, and bootstrap session/Passport middleware in the NestJS application.

Purpose: Establish the foundational layer that all auth features depend on -- schema, packages, and middleware.
Output: Backend ready to accept auth modules with sessions persisting in Redis.
</objective>

<execution_context>
@C:\Users\pc\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pc\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-security/02-RESEARCH.md
@backend/prisma/schema.prisma
@backend/src/main.ts
@backend/src/config/env.validation.ts
@backend/src/app.module.ts
@backend/package.json
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install auth dependencies and update Prisma schema</name>
  <files>
    backend/package.json
    backend/prisma/schema.prisma
  </files>
  <action>
**Install backend dependencies** (run from backend/ directory):

```bash
# Authentication core
npm install @nestjs/passport@^10.0.0 passport@^0.7.0
npm install passport-local@^1.0.0 passport-google-oauth20@^2.0.0 passport-linkedin-oauth2@^2.0.0
npm install -D @types/passport@^1.0.0 @types/passport-local@^1.0.0

# Password hashing
npm install bcrypt@^5.1.0
npm install -D @types/bcrypt@^5.0.0

# Session management
npm install express-session@^1.18.0 connect-redis@^7.0.0 ioredis@^5.0.0
npm install -D @types/express-session@^1.18.0

# Cookie parsing
npm install cookie-parser@^1.4.0
npm install -D @types/cookie-parser@^1.4.0

# Rate limiting
npm install @nestjs/throttler@^6.0.0

# Email sending
npm install @nestjs-modules/mailer@^2.0.0 nodemailer@^6.0.0 handlebars@^4.0.0
npm install -D @types/nodemailer@^6.0.0

# Config module (for injecting config in strategies)
npm install @nestjs/config@^4.0.0
```

**Update Prisma schema** (`backend/prisma/schema.prisma`):

Add these fields to the existing User model (keep all existing fields and relations):
- `googleId String? @unique` -- OAuth Google provider ID
- `linkedinId String? @unique` -- OAuth LinkedIn provider ID
- `firstName String?` -- from OAuth profile or signup
- `lastName String?` -- from OAuth profile or signup
- `avatar String?` -- from OAuth profile photo
- Add relations: `verificationTokens VerificationToken[]` and `passwordResetTokens PasswordResetToken[]`
- Add indexes: `@@index([googleId])` and `@@index([linkedinId])`

Note: The existing User model has `name String?`. Keep it for backward compatibility but also add `firstName` and `lastName`. The seed data uses `name`, auth will use `firstName`/`lastName`.

Add two new models AFTER the User model:

```prisma
model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, expiresAt])
}
```

After schema changes, run: `npx prisma generate` to regenerate the client.
Do NOT run `prisma migrate dev` yet -- that requires the database to be running. The migration will be created during execution when Docker is available, or the executor can run it.
  </action>
  <verify>
Run `npx prisma validate` in backend/ -- should output "The schema is valid".
Run `npx prisma generate` in backend/ -- should succeed without errors.
Verify `node -e "require('@nestjs/passport')"` from backend/ does not throw.
Verify `node -e "require('bcrypt')"` from backend/ does not throw.
Verify `node -e "require('ioredis')"` from backend/ does not throw.
  </verify>
  <done>
All auth packages installed in backend/package.json. Prisma schema has User with OAuth fields (googleId, linkedinId, firstName, lastName, avatar), VerificationToken model, and PasswordResetToken model. Prisma client regenerated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bootstrap session middleware, Passport, and update env validation</name>
  <files>
    backend/src/main.ts
    backend/src/config/env.validation.ts
    backend/.env.example
    docker-compose.yml
  </files>
  <action>
**Update env.validation.ts** (`backend/src/config/env.validation.ts`):

Add these new env vars to the Zod schema (keep all existing ones):
- `SESSION_SECRET: z.string().min(32, 'SESSION_SECRET must be at least 32 characters')` -- required, no default
- `GOOGLE_CLIENT_ID: z.string().optional()` -- optional during dev (OAuth won't work without it but app should start)
- `GOOGLE_CLIENT_SECRET: z.string().optional()`
- `GOOGLE_CALLBACK_URL: z.string().default('http://localhost:3001/auth/google/callback')`
- `LINKEDIN_CLIENT_ID: z.string().optional()`
- `LINKEDIN_CLIENT_SECRET: z.string().optional()`
- `LINKEDIN_CALLBACK_URL: z.string().default('http://localhost:3001/auth/linkedin/callback')`
- `EMAIL_HOST: z.string().default('smtp.gmail.com')`
- `EMAIL_PORT: z.string().transform((val) => parseInt(val, 10)).default('587')`
- `EMAIL_USER: z.string().optional()` -- optional during dev (emails won't send but app should start)
- `EMAIL_PASSWORD: z.string().optional()`
- `EMAIL_FROM: z.string().default('"Maxed-CV" <noreply@maxedcv.com>')`

**Update main.ts** (`backend/src/main.ts`):

Add imports for session, passport, cookie-parser, ioredis, and connect-redis.

After `const app = await NestFactory.create(AppModule);`, add in this order:

1. Cookie parser middleware: `app.use(cookieParser());`

2. Create Redis client using ioredis:
```typescript
const Redis = require('ioredis');
const redisClient = new Redis({
  host: env.REDIS_HOST,
  port: env.REDIS_PORT,
});
```

3. Session middleware with Redis store:
```typescript
const RedisStore = require('connect-redis').default;
app.use(
  session({
    store: new RedisStore({ client: redisClient }),
    secret: env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    rolling: true, // Sliding expiration per user decision (Claude's discretion: sliding chosen for UX)
    cookie: {
      httpOnly: true,
      secure: env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days default
    },
  }),
);
```

4. Passport initialization:
```typescript
app.use(passport.initialize());
app.use(passport.session());
```

Note: Use `require()` for connect-redis and ioredis imports if ESM import causes issues. The connect-redis v7+ exports `default` as the class.

**Update docker-compose.yml**: Add new environment variables to the backend service:
```yaml
- SESSION_SECRET=local-dev-session-secret-minimum-32-characters-long
```
Do NOT add OAuth secrets to docker-compose (those are user-specific). The app starts without them (they're optional in env validation).

**Update backend/.env.example**: Add all new env vars with placeholder values and comments explaining each one.
  </action>
  <verify>
Run `cd backend && npx ts-node -e "import './src/config/env.validation'"` -- should compile without TypeScript errors (may fail at runtime without DATABASE_URL, that's expected).
Check that docker-compose.yml has SESSION_SECRET in backend environment.
Check that backend/.env.example has all new auth-related env vars.
Verify main.ts compiles: `cd backend && npx tsc --noEmit` (may have errors from missing modules that will be created in subsequent plans -- that's expected. The focus is that the session/passport bootstrap code has no syntax errors).
  </verify>
  <done>
main.ts bootstraps cookie-parser, Redis session store (connect-redis + ioredis), express-session with sliding expiration (7-day default, httpOnly, sameSite lax), and Passport. env.validation.ts validates SESSION_SECRET (min 32 chars) and includes optional OAuth/email env vars. docker-compose.yml has SESSION_SECRET. .env.example documents all auth env vars.
  </done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes in backend/
- All auth npm packages present in backend/package.json (dependencies and devDependencies)
- backend/src/main.ts contains session middleware, passport.initialize(), passport.session()
- backend/src/config/env.validation.ts validates SESSION_SECRET with min 32 chars
- docker-compose.yml backend service has SESSION_SECRET environment variable
- backend/.env.example lists all new auth-related environment variables
</verification>

<success_criteria>
The backend has all authentication dependencies installed, Prisma schema includes OAuth user fields and token models, session middleware is configured with Redis store, Passport is bootstrapped, and environment validation enforces SESSION_SECRET. The app may not compile fully yet (auth modules not created), but the foundation is in place.
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-security/02-01-SUMMARY.md`
</output>
